<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Non-trivial unittests</title><meta name=description content="Ramblings and tech things"><meta name=keywords content><meta property="og:url" content="https://asynchronous.in/2013/07/19/non-trivial-unit-tests/"><meta property="og:type" content="website"><meta property="og:title" content="Non-trivial unittests"><meta property="og:description" content="Ramblings and tech things"><meta property="og:image" content="https://asynchronous.in"><meta property="og:image:secure_url" content="https://asynchronous.in"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Non-trivial unittests"><meta name=twitter:description content="Ramblings and tech things"><meta property="twitter:domain" content="https://asynchronous.in/2013/07/19/non-trivial-unit-tests/"><meta property="twitter:url" content="https://asynchronous.in/2013/07/19/non-trivial-unit-tests/"><meta name=twitter:image content="https://asynchronous.in"><link rel=canonical href=https://asynchronous.in/2013/07/19/non-trivial-unit-tests/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.edd985581bf860dfb4507e5885197f1680160c7fe19f23b31e183126d99dd596.js integrity="sha256-7dmFWBv4YN+0UH5YhRl/FoAWDH/hnyOzHhgxJtmd1ZY="></script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=nav-title><a class=nav-brand href=https://asynchronous.in>maxking's blog</a></div><div class=nav-links><div class=nav-link><a href=https://asynchronous.in/posts/>Posts</a></div><div class=nav-link><a href=https://asynchronous.in/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/maxking><span data-feather=github></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://asynchronous.in/posts/>Posts</a></li><li class=nav-item><a href=https://asynchronous.in/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/maxking><span data-feather=github></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Non-trivial unittests</h1><small role=doc-subtitle></small><p class=post-date>July 19, 2013</p><ul class=post-tags></ul></div><div class=post-content><p><p>Unit tests are mostly trivial to write with only those assert statements over
the expected results of the function (which is to be tested) instances. But
sometimes it gets difficult to test some functions which require test data and
the place where you store the data is not accessible in the tests.</p><p>was trying to test my <b>gpg</b> utility which uses a home directory where
all the public and secret key rings are stored(or supposed to be stored by
default) whose hard-coded-path in my project is
"/home/maxking/mailman/mailman/var/gpg" . Usually I can point to
"/home/maxking/mailman/mailman/var/" with the "config.VAR_DIR" variable which
gets initialized when the config layer is initialized during tests. What is a
layer? Mailman uses "zope.testing" framework for testing, it has a concept of
layers which instantiates all the modules of the project so that they can be
used in the tests. Occasionally you can use temporary directories and values for
testing purposes in-case you don't want the tests to alter your actual data. So
config layer creates a temp "var director" during test runtime. See the code
below for the initialization of the gpg handler:<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln>1</span><span class=cl><span class=k>class</span> <span class=nc>GPG</span><span class=p>:</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=nb>dir</span><span class=p>):</span>
</span></span><span class=line><span class=ln>3</span><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_gpg</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_home</span> <span class=o>=</span> <span class=nb>dir</span>
</span></span><span class=line><span class=ln>5</span><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_gpg</span> <span class=o>=</span> <span class=n>gnupg</span><span class=o>.</span><span class=n>GPG</span><span class=p>(</span><span class=n>gnupghome</span><span class=o>=</span><span class=bp>self</span><span class=o>.</span><span class=n>_home</span><span class=p>)</span></span></span></code></pre></div><p>And this module is used as:<div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln>1</span><span class=cl>  <span class=kn>from</span> <span class=nn>mailman.utilities.gpg</span> <span class=kn>import</span> <span class=n>GPG</span>
</span></span><span class=line><span class=ln>2</span><span class=cl>
</span></span><span class=line><span class=ln>3</span><span class=cl>  <span class=n>gpg_dir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>config</span><span class=o>.</span><span class=n>VAR_DIR</span><span class=p>,</span> <span class=s2>&#34;gpg&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>4</span><span class=cl>  <span class=n>gpg</span> <span class=o>=</span> <span class=n>GPG</span><span class=p>(</span><span class=n>gpg_dir</span><span class=p>)</span></span></span></code></pre></div><p>So the `config layer` creates a new temp var directory every time tests are
run and thus my test data inside "/home/maxking/mailman/mailman/var/gpg" is
never found during the test run. So the workaround that I was suggested by Barry
to copy the test data to whatever temp var directory that is created the tests
are now running smoothly. Below is a snippet of the code how it works:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl>  <span class=kn>from</span> <span class=nn>mailman.testing.helpers</span> <span class=kn>import</span> <span class=n>setup_keyrings</span><span class=p>,</span> <span class=n>makedirs</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>
</span></span><span class=line><span class=ln> 3</span><span class=cl>  <span class=k>class</span> <span class=nc>TestGPG</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>    <span class=s2>&#34;&#34;&#34;Testing functions in the gpg utility&#34;&#34;&#34;</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>
</span></span><span class=line><span class=ln> 6</span><span class=cl>    <span class=n>layer</span> <span class=o>=</span> <span class=n>ConfigLayer</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>
</span></span><span class=line><span class=ln> 8</span><span class=cl>    <span class=k>def</span> <span class=nf>test_keyring</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>        <span class=s2>&#34;&#34;&#34;verify the keyrings&#34;&#34;&#34;</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>
</span></span><span class=line><span class=ln>11</span><span class=cl>        <span class=n>gpg_dir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>config</span><span class=o>.</span><span class=n>VAR_DIR</span><span class=p>,</span> <span class=s1>&#39;gpg&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>        <span class=n>makedirs</span><span class=p>(</span><span class=n>gpg_dir</span><span class=p>)</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>        <span class=n>setup_keyrings</span><span class=p>(</span><span class=n>gpg_dir</span><span class=p>)</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>        <span class=n>gpg</span> <span class=o>=</span> <span class=n>GPG</span><span class=p>(</span><span class=n>gpg_dir</span><span class=p>)</span></span></span></code></pre></div><p>And below are the helper functions that are used above.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=k>def</span> <span class=nf>test_data_path</span><span class=p>(</span><span class=n>filename</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>    <span class=k>return</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>abspath</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 3</span><span class=cl>        <span class=n>resource_filename</span><span class=p>(</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>            <span class=s1>&#39;mailman.utilities.tests.data&#39;</span><span class=p>,</span> <span class=n>filename</span><span class=p>))</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>
</span></span><span class=line><span class=ln> 6</span><span class=cl><span class=k>def</span> <span class=nf>makedirs</span><span class=p>(</span><span class=nb>dir</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>        <span class=n>os</span><span class=o>.</span><span class=n>makedirs</span><span class=p>(</span><span class=nb>dir</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=k>except</span> <span class=ne>OSError</span> <span class=k>as</span> <span class=n>e</span><span class=p>:</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>        <span class=k>pass</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>
</span></span><span class=line><span class=ln>12</span><span class=cl><span class=k>def</span> <span class=nf>copy</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>dst</span><span class=p>):</span>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=n>src</span> <span class=o>=</span> <span class=n>test_data_path</span><span class=p>(</span><span class=n>filename</span><span class=p>)</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>    <span class=n>makedirs</span><span class=p>(</span><span class=n>dst</span><span class=p>)</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>    <span class=k>try</span><span class=p>:</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>        <span class=n>shutil</span><span class=o>.</span><span class=n>copy</span><span class=p>(</span><span class=n>src</span><span class=p>,</span> <span class=n>dst</span><span class=p>)</span>
</span></span><span class=line><span class=ln>17</span><span class=cl>    <span class=k>except</span> <span class=ne>IOError</span><span class=p>:</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>        <span class=k>raise</span> <span class=ne>IOError</span><span class=p>(</span><span class=s1>&#39;File </span><span class=si>{0}</span><span class=s1> copy to </span><span class=si>{1}</span><span class=s1> failed&#39;</span><span class=o>.</span><span class=n>format</span><span class=p>(</span><span class=n>filename</span><span class=p>,</span> <span class=n>dst</span><span class=p>))</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>
</span></span><span class=line><span class=ln>20</span><span class=cl><span class=k>def</span> <span class=nf>setup_keyrings</span><span class=p>(</span><span class=n>dst</span><span class=p>):</span>
</span></span><span class=line><span class=ln>21</span><span class=cl>    <span class=s2>&#34;&#34;&#34;Copy the keyrings to the right place.
</span></span></span><span class=line><span class=ln>22</span><span class=cl><span class=s2>    &#34;&#34;&#34;</span>
</span></span><span class=line><span class=ln>23</span><span class=cl>    <span class=n>keyrings</span> <span class=o>=</span> <span class=p>(</span><span class=s1>&#39;pubring.gpg&#39;</span><span class=p>,</span> <span class=s1>&#39;secring.gpg&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>24</span><span class=cl>
</span></span><span class=line><span class=ln>25</span><span class=cl>    <span class=k>for</span> <span class=n>keyring</span> <span class=ow>in</span> <span class=n>keyrings</span><span class=p>:</span>
</span></span><span class=line><span class=ln>26</span><span class=cl>        <span class=c1># The local keyrings live in the .gpg file with the same keyring name</span>
</span></span><span class=line><span class=ln>27</span><span class=cl>        <span class=c1># in the temporary directory.</span>
</span></span><span class=line><span class=ln>28</span><span class=cl>        <span class=n>copy</span><span class=p>(</span><span class=n>keyring</span><span class=p>,</span> <span class=n>dst</span><span class=p>)</span></span></span></code></pre></div></p></div><div class=prev-next></div><script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function topFunction(){smoothScrollToTop()}function smoothScrollToTop(){const e=()=>{const t=document.documentElement.scrollTop||document.body.scrollTop;t>0&&(window.requestAnimationFrame(e),window.scrollTo(0,t-t/8))};e()}</script></div></main><footer class=footer><span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>