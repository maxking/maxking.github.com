<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<title>Non-trivial unittests | maxking's blog</title><meta name=viewport content="width=device-width,minimum-scale=1">
<meta name=description content="Unit tests are mostly trivial to write with only those assert statements over the expected results of the function (which is to be tested) instances. But sometimes it gets difficult to test some functions which require test data and the place where you store the data is not accessible in the tests.
 was trying to test my gpg utility which uses a home directory where all the public and secret key rings are stored(or supposed to be stored by default) whose hard-coded-path in my project is &#34;">
<meta name=generator content="Hugo 0.93.2">
<meta name=robots content="noindex, nofollow">
<link rel=stylesheet href=/ananke/css/main.min.css>
<meta property="og:title" content="Non-trivial unittests">
<meta property="og:description" content="Unit tests are mostly trivial to write with only those assert statements over the expected results of the function (which is to be tested) instances. But sometimes it gets difficult to test some functions which require test data and the place where you store the data is not accessible in the tests.
 was trying to test my gpg utility which uses a home directory where all the public and secret key rings are stored(or supposed to be stored by default) whose hard-coded-path in my project is &#34;">
<meta property="og:type" content="article">
<meta property="og:url" content="https://asynchronous.in/2013/07/19/non-trivial-unit-tests/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2013-07-19T00:00:00+00:00">
<meta property="article:modified_time" content="2013-07-19T00:00:00+00:00">
<meta itemprop=name content="Non-trivial unittests">
<meta itemprop=description content="Unit tests are mostly trivial to write with only those assert statements over the expected results of the function (which is to be tested) instances. But sometimes it gets difficult to test some functions which require test data and the place where you store the data is not accessible in the tests.
 was trying to test my gpg utility which uses a home directory where all the public and secret key rings are stored(or supposed to be stored by default) whose hard-coded-path in my project is &#34;"><meta itemprop=datePublished content="2013-07-19T00:00:00+00:00">
<meta itemprop=dateModified content="2013-07-19T00:00:00+00:00">
<meta itemprop=wordCount content="397">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="Non-trivial unittests">
<meta name=twitter:description content="Unit tests are mostly trivial to write with only those assert statements over the expected results of the function (which is to be tested) instances. But sometimes it gets difficult to test some functions which require test data and the place where you store the data is not accessible in the tests.
 was trying to test my gpg utility which uses a home directory where all the public and secret key rings are stored(or supposed to be stored by default) whose hard-coded-path in my project is &#34;">
</head><body class="ma0 avenir bg-near-white">
<header>
<div class=bg-black>
<nav class="pv3 ph3 ph4-ns" role=navigation>
<div class="flex-l justify-between items-center center">
<a href=/ class="f3 fw2 hover-white no-underline white-90 dib">
maxking's blog
</a>
<div class="flex-l items-center">
<div class=ananke-socials>
</div></div></div></nav></div></header><main class=pb7 role=main>
<article class="flex-l flex-wrap justify-between mw8 center ph3">
<header class="mt4 w-100">
<aside class="instapaper_ignoref b helvetica tracked">
POSTS
</aside><div id=sharing class="mt3 ananke-socials">
</div><h1 class="f1 athelas mt3 mb1">Non-trivial unittests</h1><time class="f6 mv4 dib tracked" datetime=2013-07-19T00:00:00Z>July 19, 2013</time>
</header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l">
<p>Unit tests are mostly trivial to write with only those assert statements over
the expected results of the function (which is to be tested) instances. But
sometimes it gets difficult to test some functions which require test data and
the place where you store the data is not accessible in the tests.</p><p> was trying to test my <b>gpg</b> utility which uses a home directory where
all the public and secret key rings are stored(or supposed to be stored by
default) whose hard-coded-path in my project is
"/home/maxking/mailman/mailman/var/gpg" . Usually I can point to
"/home/maxking/mailman/mailman/var/" with the "config.VAR_DIR" variable which
gets initialized when the config layer is initialized during tests. What is a
layer? Mailman uses "zope.testing" framework for testing, it has a concept of
layers which instantiates all the modules of the project so that they can be
used in the tests. Occasionally you can use temporary directories and values for
testing purposes in-case you don't want the tests to alter your actual data. So
config layer creates a temp "var director" during test runtime. See the code
below for the initialization of the gpg handler:
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>GPG</span>:
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self, dir):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_gpg <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_home <span style=color:#f92672>=</span> dir
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_gpg <span style=color:#f92672>=</span> gnupg<span style=color:#f92672>.</span>GPG(gnupghome<span style=color:#f92672>=</span>self<span style=color:#f92672>.</span>_home)</span></span></code></pre></div><p>And this module is used as:
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>  <span style=color:#f92672>from</span> mailman.utilities.gpg <span style=color:#f92672>import</span> GPG
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  gpg_dir <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(config<span style=color:#f92672>.</span>VAR_DIR, <span style=color:#e6db74>&#34;gpg&#34;</span>)
</span></span><span style=display:flex><span>  gpg <span style=color:#f92672>=</span> GPG(gpg_dir)</span></span></code></pre></div><p>So the `config layer` creates a new temp var directory every time tests are
run and thus my test data inside "/home/maxking/mailman/mailman/var/gpg" is
never found during the test run. So the workaround that I was suggested by Barry
to copy the test data to whatever temp var directory that is created the tests
are now running smoothly. Below is a snippet of the code how it works:
</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>  <span style=color:#f92672>from</span> mailman.testing.helpers <span style=color:#f92672>import</span> setup_keyrings, makedirs
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestGPG</span>(unittest<span style=color:#f92672>.</span>TestCase):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Testing functions in the gpg utility&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    layer <span style=color:#f92672>=</span> ConfigLayer
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_keyring</span>(self):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;verify the keyrings&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        gpg_dir <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(config<span style=color:#f92672>.</span>VAR_DIR, <span style=color:#e6db74>&#39;gpg&#39;</span>)
</span></span><span style=display:flex><span>        makedirs(gpg_dir)
</span></span><span style=display:flex><span>        setup_keyrings(gpg_dir)
</span></span><span style=display:flex><span>        gpg <span style=color:#f92672>=</span> GPG(gpg_dir)</span></span></code></pre></div><p> And below are the helper functions that are used above.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_data_path</span>(filename):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>abspath(
</span></span><span style=display:flex><span>        resource_filename(
</span></span><span style=display:flex><span>            <span style=color:#e6db74>&#39;mailman.utilities.tests.data&#39;</span>, filename))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>makedirs</span>(dir):
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>:
</span></span><span style=display:flex><span>        os<span style=color:#f92672>.</span>makedirs(dir)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>OSError</span> <span style=color:#66d9ef>as</span> e:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>pass</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>copy</span>(filename, dst):
</span></span><span style=display:flex><span>    src <span style=color:#f92672>=</span> test_data_path(filename)
</span></span><span style=display:flex><span>    makedirs(dst)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>try</span>: 
</span></span><span style=display:flex><span>        shutil<span style=color:#f92672>.</span>copy(src, dst)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>IOError</span>:
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>raise</span> <span style=color:#a6e22e>IOError</span>(<span style=color:#e6db74>&#39;File </span><span style=color:#e6db74>{0}</span><span style=color:#e6db74> copy to </span><span style=color:#e6db74>{1}</span><span style=color:#e6db74> failed&#39;</span><span style=color:#f92672>.</span>format(filename, dst))
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>setup_keyrings</span>(dst):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Copy the keyrings to the right place.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>    keyrings <span style=color:#f92672>=</span> (<span style=color:#e6db74>&#39;pubring.gpg&#39;</span>, <span style=color:#e6db74>&#39;secring.gpg&#39;</span>)
</span></span><span style=display:flex><span>    
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> keyring <span style=color:#f92672>in</span> keyrings:
</span></span><span style=display:flex><span>        <span style=color:#75715e># The local keyrings live in the .gpg file with the same keyring name</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e># in the temporary directory.</span>
</span></span><span style=display:flex><span>        copy(keyring, dst)</span></span></code></pre></div><ul class=pa0>
</ul><div class="mt6 instapaper_ignoref">
</div></div><aside class="w-30-l mt6-l">
</aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo>
<div class="flex justify-between">
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://asynchronous.in>
&copy; maxking's blog 2022
</a>
<div>
<div class=ananke-socials>
</div></div></div></footer></body></html>