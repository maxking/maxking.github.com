<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<title>Are you mocking me? | maxking's blog</title><meta name=viewport content="width=device-width,minimum-scale=1">
<meta name=description content="Unit testing is one of the most important parts of any project. TDD (test driven development) is a good habit to cultivate, in case you are not convinced, you don't know about TDD or you have never given it a try. I started using partial TDD recently, yes only partial for what I follow is that first I write a rough outline of the code, then I write tests and then I keep on re-factoring my code till all the tests are passing.">
<meta name=generator content="Hugo 0.93.2">
<meta name=robots content="noindex, nofollow">
<link rel=stylesheet href=/ananke/css/main.min.css>
<meta property="og:title" content="Are you mocking me?">
<meta property="og:description" content="Unit testing is one of the most important parts of any project. TDD (test driven development) is a good habit to cultivate, in case you are not convinced, you don't know about TDD or you have never given it a try. I started using partial TDD recently, yes only partial for what I follow is that first I write a rough outline of the code, then I write tests and then I keep on re-factoring my code till all the tests are passing.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://asynchronous.in/2013/07/19/are-you-mocking-me/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2013-07-19T00:00:00+00:00">
<meta property="article:modified_time" content="2013-07-19T00:00:00+00:00">
<meta itemprop=name content="Are you mocking me?">
<meta itemprop=description content="Unit testing is one of the most important parts of any project. TDD (test driven development) is a good habit to cultivate, in case you are not convinced, you don't know about TDD or you have never given it a try. I started using partial TDD recently, yes only partial for what I follow is that first I write a rough outline of the code, then I write tests and then I keep on re-factoring my code till all the tests are passing."><meta itemprop=datePublished content="2013-07-19T00:00:00+00:00">
<meta itemprop=dateModified content="2013-07-19T00:00:00+00:00">
<meta itemprop=wordCount content="481">
<meta itemprop=keywords content="gsoc,mailman,python,mock,testing,"><meta name=twitter:card content="summary">
<meta name=twitter:title content="Are you mocking me?">
<meta name=twitter:description content="Unit testing is one of the most important parts of any project. TDD (test driven development) is a good habit to cultivate, in case you are not convinced, you don't know about TDD or you have never given it a try. I started using partial TDD recently, yes only partial for what I follow is that first I write a rough outline of the code, then I write tests and then I keep on re-factoring my code till all the tests are passing.">
</head><body class="ma0 avenir bg-near-white">
<header>
<div class=bg-black>
<nav class="pv3 ph3 ph4-ns" role=navigation>
<div class="flex-l justify-between items-center center">
<a href=/ class="f3 fw2 hover-white no-underline white-90 dib">
maxking's blog
</a>
<div class="flex-l items-center">
<div class=ananke-socials>
</div></div></div></nav></div></header><main class=pb7 role=main>
<article class="flex-l flex-wrap justify-between mw8 center ph3">
<header class="mt4 w-100">
<aside class="instapaper_ignoref b helvetica tracked">
POSTS
</aside><div id=sharing class="mt3 ananke-socials">
</div><h1 class="f1 athelas mt3 mb1">Are you mocking me?</h1><time class="f6 mv4 dib tracked" datetime=2013-07-19T00:00:00Z>July 19, 2013</time>
</header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l">
<p>Unit testing is one of the most important parts of any project. TDD (test
driven development) is a good habit to cultivate, in case you are not convinced,
you don't know about TDD or you have never given it a try. I started using
partial TDD recently, yes only partial for what I follow is that first I write a
rough outline of the code, then I write tests and then I keep on re-factoring my
code till all the tests are passing. Though there is a little flaw in this
method according to me -- although writing tests are mostly trivial with those
easy assert statements, sometimes you may write wrong tests which make you write
wrong code too. So put more thought in writing tests than in writing
code. Although many times you will agree with me that TDD is annoying, it does
not let you do what you actually want to do (I mean the "way" you want to do it,
the result may be same).</p><p>
So in this post I am going to talk about mocks. What are mocks? There are some
magical functions which do some abracadabra on your existing function and make
them return anything that you want without actually even thinking what they are
returning. Did I personify it a little too much? Let me explain in a little
detail with the example of where I used mocking.</p><p>
Unit tests should be independent of environment and any other module, so that
each module can be developed separately without affecting the development of
other modules. But many a times one module depends on others and in that case
it gets messy to test those functions. In my case it was the "signature" rule
which uses "gpg" utility to verify signature of messages. Here is a snippet of
the code:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>from</span> mailman.utilities.gpg <span style=color:#f92672>import</span> GPG
</span></span><span style=display:flex><span> 
</span></span><span style=display:flex><span><span style=color:#a6e22e>@implementer</span>(IRule)
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Signature</span>:
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Look for pgp-signature.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;signature&#39;</span>
</span></span><span style=display:flex><span>    description<span style=color:#f92672>=</span>_(<span style=color:#e6db74>&#39;The message has pgp-signature as application/pgp-signature part&#39;</span>)
</span></span><span style=display:flex><span>    record <span style=color:#f92672>=</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> __init__(self):
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_gpg <span style=color:#f92672>=</span> <span style=color:#66d9ef>None</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check</span>(self, mlist, msg, msgdata):
</span></span><span style=display:flex><span>        <span style=color:#e6db74>&#34;&#34;&#34;See `IRule&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>        gpg_dir <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(config<span style=color:#f92672>.</span>VAR_DIR, <span style=color:#e6db74>&#39;gpg&#39;</span>)
</span></span><span style=display:flex><span>        self<span style=color:#f92672>.</span>_gpg <span style=color:#f92672>=</span> GPG(gpg_dir)</span></span></code></pre></div><p>So if you see in line 1 we import the GPG class from <i>gpg</i> utility. But
when we write tests we don't want this function to "actually" create an instance
of GPG class and "actually" verify the signature because it is not a function of
signature rule and any errors or breakpoints in gpg utility may cause our tests
for the "working" signature rule to fail. So what do we do? We mock and then we
rock ;-). We mock the GPG instance created in signature rule to return "any
specific value" irrespective of the input. See the code below:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#f92672>import</span> mock
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>class</span> <span style=color:#a6e22e>TestSignatureMime</span>(unittest<span style=color:#f92672>.</span>TestCase):
</span></span><span style=display:flex><span>    <span style=color:#e6db74>&#34;&#34;&#34;Test the signature handler.&#34;&#34;&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>class</span> <span style=color:#a6e22e>Dummy_GPG_True</span>:    
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>def</span> __init__(self, dir):
</span></span><span style=display:flex><span>          self<span style=color:#f92672>.</span>_dir <span style=color:#f92672>=</span> dir
</span></span><span style=display:flex><span>        
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>verify_inline_signature</span>(self, data):
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>      <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>verify_detached_signature</span>(self, data):
</span></span><span style=display:flex><span>          <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>True</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#a6e22e>@mock</span><span style=color:#f92672>.</span>patch(<span style=color:#e6db74>&#39;mailman.rules.signature.GPG&#39;</span>, new<span style=color:#f92672>=</span>Dummy_GPG_True)
</span></span><span style=display:flex><span>  <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>test_good_signature</span>(self):
</span></span><span style=display:flex><span>      result <span style=color:#f92672>=</span> self<span style=color:#f92672>.</span>_rule<span style=color:#f92672>.</span>check(self<span style=color:#f92672>.</span>_mlist, self<span style=color:#f92672>.</span>_msg, {})
</span></span><span style=display:flex><span>      self<span style=color:#f92672>.</span>assertTrue(result)</span></span></code></pre></div><p> </p><ul class=pa0>
<li class="list di">
<a href=/tags/gsoc class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">gsoc</a>
</li><li class="list di">
<a href=/tags/mailman class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">mailman</a>
</li><li class="list di">
<a href=/tags/python class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">python</a>
</li><li class="list di">
<a href=/tags/mock class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">mock</a>
</li><li class="list di">
<a href=/tags/testing class="link f5 grow no-underline br-pill ba ph3 pv2 mb2 dib black sans-serif">testing</a>
</li></ul><div class="mt6 instapaper_ignoref">
</div></div><aside class="w-30-l mt6-l">
<div class="bg-light-gray pa3 nested-list-reset nested-copy-line-height nested-links">
<p class="f5 b mb3">Related</p><ul class="pa0 list">
<li class=mb2>
<a href=/2013/07/16/stuck-at-gnupg/>GNUPG and python</a>
</li><li class=mb2>
<a href=/2013/06/30/rules-and-chains/>Rules and Chains</a>
</li><li class=mb2>
<a href=/2013/06/12/gosc-into/>Gsoc 2013 - Pilot!</a>
</li></ul></div></aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo>
<div class="flex justify-between">
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://asynchronous.in>
&copy; maxking's blog 2022
</a>
<div>
<div class=ananke-socials>
</div></div></div></footer></body></html>