<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Are you mocking me?</title><meta name=description content="Ramblings and tech things"><meta name=keywords content="gsoc,mailman,python,mock,testing"><meta property="og:url" content="https://asynchronous.in/2013/07/19/are-you-mocking-me/"><meta property="og:type" content="website"><meta property="og:title" content="Are you mocking me?"><meta property="og:description" content="Ramblings and tech things"><meta property="og:image" content="https://asynchronous.in"><meta property="og:image:secure_url" content="https://asynchronous.in"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Are you mocking me?"><meta name=twitter:description content="Ramblings and tech things"><meta property="twitter:domain" content="https://asynchronous.in/2013/07/19/are-you-mocking-me/"><meta property="twitter:url" content="https://asynchronous.in/2013/07/19/are-you-mocking-me/"><meta name=twitter:image content="https://asynchronous.in"><link rel=canonical href=https://asynchronous.in/2013/07/19/are-you-mocking-me/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.edd985581bf860dfb4507e5885197f1680160c7fe19f23b31e183126d99dd596.js integrity="sha256-7dmFWBv4YN+0UH5YhRl/FoAWDH/hnyOzHhgxJtmd1ZY="></script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=nav-title><a class=nav-brand href=https://asynchronous.in>maxking's blog</a></div><div class=nav-links><div class=nav-link><a href=https://asynchronous.in/posts/>Posts</a></div><div class=nav-link><a href=https://asynchronous.in/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/maxking><span data-feather=github></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://asynchronous.in/posts/>Posts</a></li><li class=nav-item><a href=https://asynchronous.in/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/maxking><span data-feather=github></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Are you mocking me?</h1><small role=doc-subtitle></small><p class=post-date>July 19, 2013</p><ul class=post-tags><li class=post-tag><a href=https://asynchronous.in/tags/gsoc>gsoc</a></li><li class=post-tag><a href=https://asynchronous.in/tags/mailman>mailman</a></li><li class=post-tag><a href=https://asynchronous.in/tags/python>python</a></li><li class=post-tag><a href=https://asynchronous.in/tags/mock>mock</a></li><li class=post-tag><a href=https://asynchronous.in/tags/testing>testing</a></li></ul></div><div class=post-content><p><p>Unit testing is one of the most important parts of any project. TDD (test
driven development) is a good habit to cultivate, in case you are not convinced,
you don't know about TDD or you have never given it a try. I started using
partial TDD recently, yes only partial for what I follow is that first I write a
rough outline of the code, then I write tests and then I keep on re-factoring my
code till all the tests are passing. Though there is a little flaw in this
method according to me -- although writing tests are mostly trivial with those
easy assert statements, sometimes you may write wrong tests which make you write
wrong code too. So put more thought in writing tests than in writing
code. Although many times you will agree with me that TDD is annoying, it does
not let you do what you actually want to do (I mean the "way" you want to do it,
the result may be same).</p><p>So in this post I am going to talk about mocks. What are mocks? There are some
magical functions which do some abracadabra on your existing function and make
them return anything that you want without actually even thinking what they are
returning. Did I personify it a little too much? Let me explain in a little
detail with the example of where I used mocking.</p><p>Unit tests should be independent of environment and any other module, so that
each module can be developed separately without affecting the development of
other modules. But many a times one module depends on others and in that case
it gets messy to test those functions. In my case it was the "signature" rule
which uses "gpg" utility to verify signature of messages. Here is a snippet of
the code:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=kn>from</span> <span class=nn>mailman.utilities.gpg</span> <span class=kn>import</span> <span class=n>GPG</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=nd>@implementer</span><span class=p>(</span><span class=n>IRule</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl><span class=k>class</span> <span class=nc>Signature</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>    <span class=s2>&#34;&#34;&#34;Look for pgp-signature.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=ln> 6</span><span class=cl>
</span></span><span class=line><span class=ln> 7</span><span class=cl>    <span class=n>name</span><span class=o>=</span><span class=s1>&#39;signature&#39;</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>    <span class=n>description</span><span class=o>=</span><span class=n>_</span><span class=p>(</span><span class=s1>&#39;The message has pgp-signature as application/pgp-signature part&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>    <span class=n>record</span> <span class=o>=</span> <span class=kc>True</span>
</span></span><span class=line><span class=ln>10</span><span class=cl>    <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_gpg</span> <span class=o>=</span> <span class=kc>None</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>
</span></span><span class=line><span class=ln>13</span><span class=cl>    <span class=k>def</span> <span class=nf>check</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>mlist</span><span class=p>,</span> <span class=n>msg</span><span class=p>,</span> <span class=n>msgdata</span><span class=p>):</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>        <span class=s2>&#34;&#34;&#34;See `IRule&#34;&#34;&#34;</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>        <span class=n>gpg_dir</span> <span class=o>=</span> <span class=n>os</span><span class=o>.</span><span class=n>path</span><span class=o>.</span><span class=n>join</span><span class=p>(</span><span class=n>config</span><span class=o>.</span><span class=n>VAR_DIR</span><span class=p>,</span> <span class=s1>&#39;gpg&#39;</span><span class=p>)</span>
</span></span><span class=line><span class=ln>16</span><span class=cl>        <span class=bp>self</span><span class=o>.</span><span class=n>_gpg</span> <span class=o>=</span> <span class=n>GPG</span><span class=p>(</span><span class=n>gpg_dir</span><span class=p>)</span></span></span></code></pre></div><p>So if you see in line 1 we import the GPG class from <i>gpg</i> utility. But
when we write tests we don't want this function to "actually" create an instance
of GPG class and "actually" verify the signature because it is not a function of
signature rule and any errors or breakpoints in gpg utility may cause our tests
for the "working" signature rule to fail. So what do we do? We mock and then we
rock ;-). We mock the GPG instance created in signature rule to return "any
specific value" irrespective of the input. See the code below:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=ln> 1</span><span class=cl><span class=kn>import</span> <span class=nn>mock</span>
</span></span><span class=line><span class=ln> 2</span><span class=cl>
</span></span><span class=line><span class=ln> 3</span><span class=cl><span class=k>class</span> <span class=nc>TestSignatureMime</span><span class=p>(</span><span class=n>unittest</span><span class=o>.</span><span class=n>TestCase</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>    <span class=s2>&#34;&#34;&#34;Test the signature handler.&#34;&#34;&#34;</span>
</span></span><span class=line><span class=ln> 5</span><span class=cl>
</span></span><span class=line><span class=ln> 6</span><span class=cl>  <span class=k>class</span> <span class=nc>Dummy_GPG_True</span><span class=p>:</span>
</span></span><span class=line><span class=ln> 7</span><span class=cl>      <span class=k>def</span> <span class=fm>__init__</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=nb>dir</span><span class=p>):</span>
</span></span><span class=line><span class=ln> 8</span><span class=cl>          <span class=bp>self</span><span class=o>.</span><span class=n>_dir</span> <span class=o>=</span> <span class=nb>dir</span>
</span></span><span class=line><span class=ln> 9</span><span class=cl>
</span></span><span class=line><span class=ln>10</span><span class=cl>      <span class=k>def</span> <span class=nf>verify_inline_signature</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=ln>11</span><span class=cl>          <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=ln>12</span><span class=cl>
</span></span><span class=line><span class=ln>13</span><span class=cl>      <span class=k>def</span> <span class=nf>verify_detached_signature</span><span class=p>(</span><span class=bp>self</span><span class=p>,</span> <span class=n>data</span><span class=p>):</span>
</span></span><span class=line><span class=ln>14</span><span class=cl>          <span class=k>return</span> <span class=kc>True</span>
</span></span><span class=line><span class=ln>15</span><span class=cl>
</span></span><span class=line><span class=ln>16</span><span class=cl>
</span></span><span class=line><span class=ln>17</span><span class=cl>  <span class=nd>@mock.patch</span><span class=p>(</span><span class=s1>&#39;mailman.rules.signature.GPG&#39;</span><span class=p>,</span> <span class=n>new</span><span class=o>=</span><span class=n>Dummy_GPG_True</span><span class=p>)</span>
</span></span><span class=line><span class=ln>18</span><span class=cl>  <span class=k>def</span> <span class=nf>test_good_signature</span><span class=p>(</span><span class=bp>self</span><span class=p>):</span>
</span></span><span class=line><span class=ln>19</span><span class=cl>      <span class=n>result</span> <span class=o>=</span> <span class=bp>self</span><span class=o>.</span><span class=n>_rule</span><span class=o>.</span><span class=n>check</span><span class=p>(</span><span class=bp>self</span><span class=o>.</span><span class=n>_mlist</span><span class=p>,</span> <span class=bp>self</span><span class=o>.</span><span class=n>_msg</span><span class=p>,</span> <span class=p>{})</span>
</span></span><span class=line><span class=ln>20</span><span class=cl>      <span class=bp>self</span><span class=o>.</span><span class=n>assertTrue</span><span class=p>(</span><span class=n>result</span><span class=p>)</span></span></span></code></pre></div><p></p></p></div><div class=prev-next></div><script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function topFunction(){smoothScrollToTop()}function smoothScrollToTop(){const e=()=>{const t=document.documentElement.scrollTop||document.body.scrollTop;t>0&&(window.requestAnimationFrame(e),window.scrollTo(0,t-t/8))};e()}</script></div></main><footer class=footer><span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>