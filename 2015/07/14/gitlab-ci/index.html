<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Gitlab CI?</title><meta name=description content="Ramblings and tech things"><meta name=keywords content><meta property="og:url" content="https://asynchronous.in/2015/07/14/gitlab-ci/"><meta property="og:type" content="website"><meta property="og:title" content="Gitlab CI?"><meta property="og:description" content="Ramblings and tech things"><meta property="og:image" content="https://asynchronous.in"><meta property="og:image:secure_url" content="https://asynchronous.in"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Gitlab CI?"><meta name=twitter:description content="Ramblings and tech things"><meta property="twitter:domain" content="https://asynchronous.in/2015/07/14/gitlab-ci/"><meta property="twitter:url" content="https://asynchronous.in/2015/07/14/gitlab-ci/"><meta name=twitter:image content="https://asynchronous.in"><link rel=canonical href=https://asynchronous.in/2015/07/14/gitlab-ci/><link rel=stylesheet type=text/css href=/css/normalize.min.css media=print><link rel=stylesheet type=text/css href=/css/main.min.css><link id=dark-theme rel=stylesheet href=/css/dark.min.css><script src=/js/bundle.min.edd985581bf860dfb4507e5885197f1680160c7fe19f23b31e183126d99dd596.js integrity="sha256-7dmFWBv4YN+0UH5YhRl/FoAWDH/hnyOzHhgxJtmd1ZY="></script></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=nav-title><a class=nav-brand href=https://asynchronous.in>maxking's blog</a></div><div class=nav-links><div class=nav-link><a href=https://asynchronous.in/posts/>Posts</a></div><div class=nav-link><a href=https://asynchronous.in/tags/>Tags</a></div><div class=nav-link><a href=https://github.com/maxking><span data-feather=github></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only></span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><span id=hamburger-menu-toggle-screen-reader-target class=sr-only>menu</span>
<a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://asynchronous.in/posts/>Posts</a></li><li class=nav-item><a href=https://asynchronous.in/tags/>Tags</a></li><li class=nav-item><a href=https://github.com/maxking><span data-feather=github></span></a></li><li class="nav-item dark-theme-toggle"><span id=dark-theme-toggle-screen-reader-target class=sr-only>theme</span>
<a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content><div class="post container"><div class=post-header-section><h1>Gitlab CI?</h1><small role=doc-subtitle></small><p class=post-date>July 14, 2015</p><ul class=post-tags></ul></div><div class=post-content><p><p>Note: This post is now outdated. GNU Mailman now has a <a href=http://hub.docker.com/u/maxking/mailman-ci-runner/>new container image</a>
for running tests and this time it <em>just works</em>.</p><p>Being one of the core developers of GNU Mailman, I took up the task to setup
a Continuous Integration server for Mailman. While looking for a service using
FOSS and was free to use I stumbled upon <a href=https://ci.gitlab.com>Gitlab CI</a>. There were several
other options to choose from, but none of them fulfilled our requirement of
using FOSS. Gitlab is a FOSS and its source code is available on <a href=https://gitlab.com/gitlab-org/gitlab-ci>Gitlab</a> as
well as <a href=https://github.com/gitlabhq/gitlab-ci>Github</a>.</p><p>Now, the model of Gitlab CI is different from the others you would have
encountered before like Travis-CI or Circle-CI. Gitlab CI only provides an
interface to view the results of the tests associated with each commit or
Pull Request. The actual tests are run using gitlab-ci&rsquo;s runners which can
be run on any other system <a href=https://ci.gitlab.com>1</a>. The latest <a href=https://gitlab.com/gitlab-org/gitlab-ci-multi-runner>gitlab-ci-multi-runner</a>
is written in Go and can run tests for multiple repositories 2.</p><p>Gitlab CI can be used to run tests in a couple of ways:</p><ul><li>locally</li><li>using Docker container</li><li>using Docker container and executing job over SSH</li><li>connecting to remote SSH server</li><li>using a Parallels VM</li></ul><p>Since we wanted to build Pull Requests, considering the security implication
of running a running un-trusted code inside a server/local-machine, I decided
to go with the 3rd option. Docker running in unprilidged mode and with no root
access, even inside the docker container ,could do much less harm. So, for this
setup I needed the following things:</p><ul><li>A docker image inside which your tests are gonna run</li><li>The above image have ssh-access</li><li>A postgres database image linked to the above container</li></ul><p>I created a new docker image called <a href=https://registry.hub.docker.com/u/maxking/mailman-runner/>&lsquo;mailman-runner&rsquo;</a> to run the tests. Its
Dockerfile<a href=https://github.com/maxking/docker-mailman-ci>6</a> is also available on Github if you would like to view to suggest
edits.</p><p>Install Docker first</p><pre tabindex=0><code>	curl -sSL https://get.docker.com/ | sh
</code></pre><p>We need to mount a data volume into our gitlab-ci-multi-runner container to be
used for configs and other resources:</p><pre tabindex=0><code>	docker run -d --name multi-runner --restart always \
	-v /var/run/docker.sock:/var/run/docker.sock \
	-v /PATH/TO/DATA/FOLDER:/data \
	ayufan/gitlab-ci-multi-runner:latest
</code></pre><p>The <code>-v</code> option is used to add a data volume to the container. Here we add
a data volumen and a docker-socker to the container so that it can spawn new
containers to run tests in.</p><p>Now, register the runner:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=ln> 1</span><span class=cl>docker <span class=nb>exec</span> -it multi-runner gitlab-ci-multi-runner register
</span></span><span class=line><span class=ln> 2</span><span class=cl>
</span></span><span class=line><span class=ln> 3</span><span class=cl>Please enter the gitlab-ci coordinator URL <span class=o>(</span>e.g. http://gitlab-ci.org:3000/ <span class=o>)</span>
</span></span><span class=line><span class=ln> 4</span><span class=cl>https://ci.gitlab.com/
</span></span><span class=line><span class=ln> 5</span><span class=cl>Please enter the gitlab-ci token <span class=k>for</span> this runner
</span></span><span class=line><span class=ln> 6</span><span class=cl>xxx
</span></span><span class=line><span class=ln> 7</span><span class=cl>Please enter the gitlab-ci description <span class=k>for</span> this runner
</span></span><span class=line><span class=ln> 8</span><span class=cl>my-runner
</span></span><span class=line><span class=ln> 9</span><span class=cl>INFO<span class=o>[</span>0034<span class=o>]</span> fcf5c619 Registering runner... succeeded
</span></span><span class=line><span class=ln>10</span><span class=cl>Please enter the executor: shell, docker, docker-ssh, ssh?
</span></span><span class=line><span class=ln>11</span><span class=cl>docker-ssh
</span></span><span class=line><span class=ln>12</span><span class=cl>Please enter the Docker image <span class=o>(</span>eg. ruby:2.1<span class=o>)</span>:
</span></span><span class=line><span class=ln>13</span><span class=cl>mailman-runner:latest
</span></span><span class=line><span class=ln>14</span><span class=cl>If you want to <span class=nb>enable</span> mysql please enter version <span class=o>(</span>X.Y<span class=o>)</span> or enter latest?
</span></span><span class=line><span class=ln>15</span><span class=cl>
</span></span><span class=line><span class=ln>16</span><span class=cl>If you want to <span class=nb>enable</span> postgres please enter version <span class=o>(</span>X.Y<span class=o>)</span> or enter latest?
</span></span><span class=line><span class=ln>17</span><span class=cl>
</span></span><span class=line><span class=ln>18</span><span class=cl>If you want to <span class=nb>enable</span> redis please enter version <span class=o>(</span>X.Y<span class=o>)</span> or enter latest?
</span></span><span class=line><span class=ln>19</span><span class=cl>
</span></span><span class=line><span class=ln>20</span><span class=cl>If you want to <span class=nb>enable</span> mongo please enter version <span class=o>(</span>X.Y<span class=o>)</span> or enter latest?
</span></span><span class=line><span class=ln>21</span><span class=cl>
</span></span><span class=line><span class=ln>22</span><span class=cl>Please enter the SSH user <span class=o>(</span>eg. root<span class=o>)</span>:
</span></span><span class=line><span class=ln>23</span><span class=cl>runner
</span></span><span class=line><span class=ln>24</span><span class=cl>Please enter the SSH password <span class=o>(</span>eg. docker.io<span class=o>)</span>:
</span></span><span class=line><span class=ln>25</span><span class=cl>runner
</span></span><span class=line><span class=ln>26</span><span class=cl>
</span></span><span class=line><span class=ln>27</span><span class=cl>INFO<span class=o>[</span>0037<span class=o>]</span> Runner registered successfully. Feel free to start it, but <span class=k>if</span> it<span class=err>&#39;</span>s
</span></span><span class=line><span class=ln>28</span><span class=cl>running already the config should be automatically reloaded!
</span></span></code></pre></div><p><em>Note: The ssh user and password in the above configuration was created by
default in the mailman-runner docker image.</em></p><p>After this, the configuration file (config.toml) would look somewhat like
this:</p><pre tabindex=0><code>concurrent = 4

[[runners]]
  name = &#34;second-runner&#34;
  url = &#34;https://ci.gitlab.com&#34;
  token = &#34;XXX&#34;
  executor = &#34;docker-ssh&#34;
  [runners.ssh]
    user = &#34;runner&#34;
    password = &#34;runner&#34;
  [runners.docker]
    image = &#34;mailman-runner&#34;
    privileged = false
    volumes = [&#34;/cache&#34;]
</code></pre><p>PS:</p><ol><li><p>Now, Gitlab CI has a concept of shared runners where you can use
some public runners to run your tests. This update was added recently.</p></li><li><p>Previously, one runner could be used for only one repository. You
needed to start another instance of the same runner to run tests for
another reposiroty. However, now you can share runners across all your
repositories even if they belong to a group.</p></li></ol></p></div><div class=prev-next></div><script>let backToTopButton=document.getElementById("btt-button");window.onscroll=function(){scrollFunction()};function scrollFunction(){document.body.scrollTop>20||document.documentElement.scrollTop>20?backToTopButton.style.display="block":backToTopButton.style.display="none"}function topFunction(){smoothScrollToTop()}function smoothScrollToTop(){const e=()=>{const t=document.documentElement.scrollTop||document.body.scrollTop;t>0&&(window.requestAnimationFrame(e),window.scrollTo(0,t-t/8))};e()}</script></div></main><footer class=footer><span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>