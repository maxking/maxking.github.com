<!doctype html><html lang=en-us>
<head>
<meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge,chrome=1">
<title>Gitlab CI? | maxking's blog</title><meta name=viewport content="width=device-width,minimum-scale=1">
<meta name=description content="Note: This post is now outdated. GNU Mailman now has a new container image for running tests and this time it just works. Being one of the core developers of GNU Mailman, I took up the task to setup a Continuous Integration server for Mailman. While looking for a service using FOSS and was free to use I stumbled upon Gitlab CI. There were several other options to choose from, but none of them fulfilled our requirement of using FOSS.">
<meta name=generator content="Hugo 0.93.2">
<meta name=robots content="noindex, nofollow">
<link rel=stylesheet href=/ananke/css/main.min.css>
<meta property="og:title" content="Gitlab CI?">
<meta property="og:description" content="Note: This post is now outdated. GNU Mailman now has a new container image for running tests and this time it just works. Being one of the core developers of GNU Mailman, I took up the task to setup a Continuous Integration server for Mailman. While looking for a service using FOSS and was free to use I stumbled upon Gitlab CI. There were several other options to choose from, but none of them fulfilled our requirement of using FOSS.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://asynchronous.in/2015/07/14/gitlab-ci/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2015-07-14T00:00:00+00:00">
<meta property="article:modified_time" content="2015-07-14T00:00:00+00:00">
<meta itemprop=name content="Gitlab CI?">
<meta itemprop=description content="Note: This post is now outdated. GNU Mailman now has a new container image for running tests and this time it just works. Being one of the core developers of GNU Mailman, I took up the task to setup a Continuous Integration server for Mailman. While looking for a service using FOSS and was free to use I stumbled upon Gitlab CI. There were several other options to choose from, but none of them fulfilled our requirement of using FOSS."><meta itemprop=datePublished content="2015-07-14T00:00:00+00:00">
<meta itemprop=dateModified content="2015-07-14T00:00:00+00:00">
<meta itemprop=wordCount content="669">
<meta itemprop=keywords content><meta name=twitter:card content="summary">
<meta name=twitter:title content="Gitlab CI?">
<meta name=twitter:description content="Note: This post is now outdated. GNU Mailman now has a new container image for running tests and this time it just works. Being one of the core developers of GNU Mailman, I took up the task to setup a Continuous Integration server for Mailman. While looking for a service using FOSS and was free to use I stumbled upon Gitlab CI. There were several other options to choose from, but none of them fulfilled our requirement of using FOSS.">
</head><body class="ma0 avenir bg-near-white">
<header>
<div class=bg-black>
<nav class="pv3 ph3 ph4-ns" role=navigation>
<div class="flex-l justify-between items-center center">
<a href=/ class="f3 fw2 hover-white no-underline white-90 dib">
maxking's blog
</a>
<div class="flex-l items-center">
<div class=ananke-socials>
</div></div></div></nav></div></header><main class=pb7 role=main>
<article class="flex-l flex-wrap justify-between mw8 center ph3">
<header class="mt4 w-100">
<aside class="instapaper_ignoref b helvetica tracked">
POSTS
</aside><div id=sharing class="mt3 ananke-socials">
</div><h1 class="f1 athelas mt3 mb1">Gitlab CI?</h1><time class="f6 mv4 dib tracked" datetime=2015-07-14T00:00:00Z>July 14, 2015</time>
</header><div class="nested-copy-line-height lh-copy serif f4 nested-links mid-gray pr4-l w-two-thirds-l"><p>Note: This post is now outdated. GNU Mailman now has a <a href=http://hub.docker.com/u/maxking/mailman-ci-runner/>new container image</a>
for running tests and this time it <em>just works</em>.
</p><p>Being one of the core developers of GNU Mailman, I took up the task to setup
a Continuous Integration server for Mailman. While looking for a service using
FOSS and was free to use I stumbled upon <a href=https://ci.gitlab.com>Gitlab CI</a>. There were several
other options to choose from, but none of them fulfilled our requirement of
using FOSS. Gitlab is a FOSS and its source code is available on <a href=https://gitlab.com/gitlab-org/gitlab-ci>Gitlab</a> as
well as <a href=https://github.com/gitlabhq/gitlab-ci>Github</a>.</p><p>Now, the model of Gitlab CI is different from the others you would have
encountered before like Travis-CI or Circle-CI. Gitlab CI only provides an
interface to view the results of the tests associated with each commit or
Pull Request. The actual tests are run using gitlab-ci&rsquo;s runners which can
be run on any other system <a href=https://ci.gitlab.com>1</a>. The latest <a href=https://gitlab.com/gitlab-org/gitlab-ci-multi-runner>gitlab-ci-multi-runner</a>
is written in Go and can run tests for multiple repositories 2.</p><p>Gitlab CI can be used to run tests in a couple of ways:</p><ul>
<li>locally</li><li>using Docker container</li><li>using Docker container and executing job over SSH</li><li>connecting to remote SSH server</li><li>using a Parallels VM</li></ul><p>Since we wanted to build Pull Requests, considering the security implication
of running a running un-trusted code inside a server/local-machine, I decided
to go with the 3rd option. Docker running in unprilidged mode and with no root
access, even inside the docker container ,could do much less harm. So, for this
setup I needed the following things:</p><ul>
<li>A docker image inside which your tests are gonna run</li><li>The above image have ssh-access</li><li>A postgres database image linked to the above container</li></ul><p>I created a new docker image called <a href=https://registry.hub.docker.com/u/maxking/mailman-runner/>&lsquo;mailman-runner&rsquo;</a> to run the tests. Its
Dockerfile<a href=https://github.com/maxking/docker-mailman-ci>6</a> is also available on Github if you would like to view to suggest
edits.</p><p>Install Docker first</p><pre tabindex=0><code>	curl -sSL https://get.docker.com/ | sh
</code></pre><p>We need to mount a data volume into our gitlab-ci-multi-runner container to be
used for configs and other resources:</p><pre tabindex=0><code>	docker run -d --name multi-runner --restart always \
	-v /var/run/docker.sock:/var/run/docker.sock \
	-v /PATH/TO/DATA/FOLDER:/data \
	ayufan/gitlab-ci-multi-runner:latest
</code></pre><p>The <code>-v</code> option is used to add a data volume to the container. Here we add
a data volumen and a docker-socker to the container so that it can spawn new
containers to run tests in.</p><p>Now, register the runner:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker exec -it multi-runner gitlab-ci-multi-runner register
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Please enter the gitlab-ci coordinator URL <span style=color:#f92672>(</span>e.g. http://gitlab-ci.org:3000/ <span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>https://ci.gitlab.com/
</span></span><span style=display:flex><span>Please enter the gitlab-ci token <span style=color:#66d9ef>for</span> this runner
</span></span><span style=display:flex><span>xxx
</span></span><span style=display:flex><span>Please enter the gitlab-ci description <span style=color:#66d9ef>for</span> this runner
</span></span><span style=display:flex><span>my-runner
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0034<span style=color:#f92672>]</span> fcf5c619 Registering runner... succeeded
</span></span><span style=display:flex><span>Please enter the executor: shell, docker, docker-ssh, ssh?
</span></span><span style=display:flex><span>docker-ssh
</span></span><span style=display:flex><span>Please enter the Docker image <span style=color:#f92672>(</span>eg. ruby:2.1<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>mailman-runner:latest
</span></span><span style=display:flex><span>If you want to enable mysql please enter version <span style=color:#f92672>(</span>X.Y<span style=color:#f92672>)</span> or enter latest?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>If you want to enable postgres please enter version <span style=color:#f92672>(</span>X.Y<span style=color:#f92672>)</span> or enter latest?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>If you want to enable redis please enter version <span style=color:#f92672>(</span>X.Y<span style=color:#f92672>)</span> or enter latest?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>If you want to enable mongo please enter version <span style=color:#f92672>(</span>X.Y<span style=color:#f92672>)</span> or enter latest?
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Please enter the SSH user <span style=color:#f92672>(</span>eg. root<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>runner
</span></span><span style=display:flex><span>Please enter the SSH password <span style=color:#f92672>(</span>eg. docker.io<span style=color:#f92672>)</span>:
</span></span><span style=display:flex><span>runner
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>INFO<span style=color:#f92672>[</span>0037<span style=color:#f92672>]</span> Runner registered successfully. Feel free to start it, but <span style=color:#66d9ef>if</span> it<span style=color:#960050;background-color:#1e0010>&#39;</span>s
</span></span><span style=display:flex><span>running already the config should be automatically reloaded!
</span></span></code></pre></div><p><em>Note: The ssh user and password in the above configuration was created by
default in the mailman-runner docker image.</em></p><p>After this, the configuration file (config.toml) would look somewhat like
this:</p><pre tabindex=0><code>concurrent = 4

[[runners]]
  name = &#34;second-runner&#34;
  url = &#34;https://ci.gitlab.com&#34;
  token = &#34;XXX&#34;
  executor = &#34;docker-ssh&#34;
  [runners.ssh]
    user = &#34;runner&#34;
    password = &#34;runner&#34;
  [runners.docker]
    image = &#34;mailman-runner&#34;
    privileged = false
    volumes = [&#34;/cache&#34;]
</code></pre><p>PS:</p><ol>
<li>
<p>Now, Gitlab CI has a concept of shared runners where you can use
some public runners to run your tests. This update was added recently.</p></li><li>
<p>Previously, one runner could be used for only one repository. You
needed to start another instance of the same runner to run tests for
another reposiroty. However, now you can share runners across all your
repositories even if they belong to a group.</p></li></ol><ul class=pa0>
</ul><div class="mt6 instapaper_ignoref">
</div></div><aside class="w-30-l mt6-l">
</aside></article></main><footer class="bg-black bottom-0 w-100 pa3" role=contentinfo>
<div class="flex justify-between">
<a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href=https://asynchronous.in>
&copy; maxking's blog 2022
</a>
<div>
<div class=ananke-socials>
</div></div></div></footer></body></html>